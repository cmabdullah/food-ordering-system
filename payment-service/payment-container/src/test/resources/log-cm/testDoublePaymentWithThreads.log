Hibernate: select orderoutbo0_.id as id1_2_, orderoutbo0_.created_at as created_2_2_, orderoutbo0_.outbox_status as outbox_s3_2_, orderoutbo0_.payload as payload4_2_, orderoutbo0_.payment_status as payment_5_2_, orderoutbo0_.processed_at as processe6_2_, orderoutbo0_.saga_id as saga_id7_2_, orderoutbo0_.type as type8_2_, orderoutbo0_.version as version9_2_ from order_outbox orderoutbo0_ where orderoutbo0_.type=? and orderoutbo0_.saga_id=? and orderoutbo0_.payment_status=? and orderoutbo0_.outbox_status=?
Hibernate: select orderoutbo0_.id as id1_2_, orderoutbo0_.created_at as created_2_2_, orderoutbo0_.outbox_status as outbox_s3_2_, orderoutbo0_.payload as payload4_2_, orderoutbo0_.payment_status as payment_5_2_, orderoutbo0_.processed_at as processe6_2_, orderoutbo0_.saga_id as saga_id7_2_, orderoutbo0_.type as type8_2_, orderoutbo0_.version as version9_2_ from order_outbox orderoutbo0_ where orderoutbo0_.type=? and orderoutbo0_.saga_id=? and orderoutbo0_.payment_status=? and orderoutbo0_.outbox_status=?
2023-03-15 22:09:27.218  INFO 2738 --- [pool-1-thread-2] c.f.o.s.p.s.domain.PaymentRequestHelper  : Received payment complete event for order id: 471ae5d1-31d1-48bb-91fe-3b5654efb410
2023-03-15 22:09:27.218  INFO 2738 --- [pool-1-thread-1] c.f.o.s.p.s.domain.PaymentRequestHelper  : Received payment complete event for order id: 39ad0183-7d9f-4998-a77e-46fb757781f6
Hibernate: select creditentr0_.id as id1_0_, creditentr0_.customer_id as customer2_0_, creditentr0_.total_credit_amount as total_cr3_0_ from credit_entry creditentr0_ where creditentr0_.customer_id=?
Hibernate: select creditentr0_.id as id1_0_, creditentr0_.customer_id as customer2_0_, creditentr0_.total_credit_amount as total_cr3_0_ from credit_entry creditentr0_ where creditentr0_.customer_id=?
Hibernate: select credithist0_.id as id1_1_, credithist0_.amount as amount2_1_, credithist0_.customer_id as customer3_1_, credithist0_.type as type4_1_ from credit_history credithist0_ where credithist0_.customer_id=?
Hibernate: select credithist0_.id as id1_1_, credithist0_.amount as amount2_1_, credithist0_.customer_id as customer3_1_, credithist0_.type as type4_1_ from credit_history credithist0_ where credithist0_.customer_id=?
2023-03-15 22:09:27.366  INFO 2738 --- [pool-1-thread-2] c.f.o.s.p.s.d.PaymentDomainServiceImpl   : Payment is initiated for order id: 471ae5d1-31d1-48bb-91fe-3b5654efb410
2023-03-15 22:09:27.393  INFO 2738 --- [pool-1-thread-1] c.f.o.s.p.s.d.PaymentDomainServiceImpl   : Payment is initiated for order id: 39ad0183-7d9f-4998-a77e-46fb757781f6
Hibernate: select paymentent0_.id as id1_3_0_, paymentent0_.created_at as created_2_3_0_, paymentent0_.customer_id as customer3_3_0_, paymentent0_.order_id as order_id4_3_0_, paymentent0_.price as price5_3_0_, paymentent0_.status as status6_3_0_ from payments paymentent0_ where paymentent0_.id=?
Hibernate: select paymentent0_.id as id1_3_0_, paymentent0_.created_at as created_2_3_0_, paymentent0_.customer_id as customer3_3_0_, paymentent0_.order_id as order_id4_3_0_, paymentent0_.price as price5_3_0_, paymentent0_.status as status6_3_0_ from payments paymentent0_ where paymentent0_.id=?
Hibernate: select credithist0_.id as id1_1_0_, credithist0_.amount as amount2_1_0_, credithist0_.customer_id as customer3_1_0_, credithist0_.type as type4_1_0_ from credit_history credithist0_ where credithist0_.id=?
Hibernate: select credithist0_.id as id1_1_0_, credithist0_.amount as amount2_1_0_, credithist0_.customer_id as customer3_1_0_, credithist0_.type as type4_1_0_ from credit_history credithist0_ where credithist0_.id=?
Hibernate: select orderoutbo0_.id as id1_2_0_, orderoutbo0_.created_at as created_2_2_0_, orderoutbo0_.outbox_status as outbox_s3_2_0_, orderoutbo0_.payload as payload4_2_0_, orderoutbo0_.payment_status as payment_5_2_0_, orderoutbo0_.processed_at as processe6_2_0_, orderoutbo0_.saga_id as saga_id7_2_0_, orderoutbo0_.type as type8_2_0_, orderoutbo0_.version as version9_2_0_ from order_outbox orderoutbo0_ where orderoutbo0_.id=?
Hibernate: select orderoutbo0_.id as id1_2_0_, orderoutbo0_.created_at as created_2_2_0_, orderoutbo0_.outbox_status as outbox_s3_2_0_, orderoutbo0_.payload as payload4_2_0_, orderoutbo0_.payment_status as payment_5_2_0_, orderoutbo0_.processed_at as processe6_2_0_, orderoutbo0_.saga_id as saga_id7_2_0_, orderoutbo0_.type as type8_2_0_, orderoutbo0_.version as version9_2_0_ from order_outbox orderoutbo0_ where orderoutbo0_.id=?
2023-03-15 22:09:27.663  INFO 2738 --- [pool-1-thread-1] c.f.o.s.p.s.d.o.s.OrderOutboxHelper      : OrderOutboxMessage is saved with id: 08b88a70-540d-430a-bf70-8fbe0d619b29
2023-03-15 22:09:27.665  INFO 2738 --- [pool-1-thread-2] c.f.o.s.p.s.d.o.s.OrderOutboxHelper      : OrderOutboxMessage is saved with id: 621e7505-462a-45b5-a3f7-a0e9d64915a6
Hibernate: insert into payments (created_at, customer_id, order_id, price, status, id) values (?, ?, ?, ?, ?, ?)
Hibernate: insert into payments (created_at, customer_id, order_id, price, status, id) values (?, ?, ?, ?, ?, ?)
Hibernate: insert into credit_history (amount, customer_id, type, id) values (?, ?, ?, ?)
Hibernate: insert into order_outbox (created_at, outbox_status, payload, payment_status, processed_at, saga_id, type, version, id) values (?, ?, ?, ?, ?, ?, ?, ?, ?)
Hibernate: update credit_entry set customer_id=?, total_credit_amount=? where id=?
Hibernate: insert into credit_history (amount, customer_id, type, id) values (?, ?, ?, ?)
Hibernate: insert into order_outbox (created_at, outbox_status, payload, payment_status, processed_at, saga_id, type, version, id) values (?, ?, ?, ?, ?, ?, ?, ?, ?)
2023-03-15 22:09:27.764  INFO 2738 --- [-consumer-2-C-1] org.apache.kafka.clients.Metadata        : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] Cluster ID: VQ1bB0ThSvaTYhqMF_orDQ
2023-03-15 22:09:27.764  INFO 2738 --- [-consumer-0-C-1] org.apache.kafka.clients.Metadata        : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] Cluster ID: VQ1bB0ThSvaTYhqMF_orDQ
2023-03-15 22:09:27.767  INFO 2738 --- [-consumer-1-C-1] org.apache.kafka.clients.Metadata        : [Consumer clientId=consumer-payment-topic-consumer-2, groupId=payment-topic-consumer] Cluster ID: VQ1bB0ThSvaTYhqMF_orDQ
2023-03-15 22:09:27.768  INFO 2738 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] Discovered group coordinator 192.168.0.4:9092 (id: 2147483647 rack: null)
2023-03-15 22:09:27.769  INFO 2738 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] Discovered group coordinator 192.168.0.4:9092 (id: 2147483647 rack: null)
2023-03-15 22:09:27.773  INFO 2738 --- [-consumer-1-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-2, groupId=payment-topic-consumer] Discovered group coordinator 192.168.0.4:9092 (id: 2147483647 rack: null)
2023-03-15 22:09:27.776  INFO 2738 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] (Re-)joining group
2023-03-15 22:09:27.783  INFO 2738 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] (Re-)joining group
2023-03-15 22:09:27.795  INFO 2738 --- [-consumer-1-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-2, groupId=payment-topic-consumer] (Re-)joining group
2023-03-15 22:09:27.815  INFO 2738 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] Request joining group due to: need to re-join with the given member-id
2023-03-15 22:09:27.815  INFO 2738 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] Request joining group due to: need to re-join with the given member-id
2023-03-15 22:09:27.815  INFO 2738 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] (Re-)joining group
2023-03-15 22:09:27.816  INFO 2738 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] (Re-)joining group
2023-03-15 22:09:27.818  INFO 2738 --- [-consumer-1-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-2, groupId=payment-topic-consumer] Request joining group due to: need to re-join with the given member-id
2023-03-15 22:09:27.819  INFO 2738 --- [-consumer-1-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-2, groupId=payment-topic-consumer] (Re-)joining group
2023-03-15 22:09:27.822  INFO 2738 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] Successfully joined group with generation Generation{generationId=4, memberId='consumer-payment-topic-consumer-3-d232888b-97ac-4bda-ba94-8813dd7fdd0a', protocol='range'}
2023-03-15 22:09:27.822  INFO 2738 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] Successfully joined group with generation Generation{generationId=4, memberId='consumer-payment-topic-consumer-1-869a5012-379d-4d55-8302-ea59516b9534', protocol='range'}
2023-03-15 22:09:27.827  INFO 2738 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] SyncGroup failed: The group began another rebalance. Need to re-join the group. Sent generation was Generation{generationId=4, memberId='consumer-payment-topic-consumer-3-d232888b-97ac-4bda-ba94-8813dd7fdd0a', protocol='range'}
2023-03-15 22:09:27.828  INFO 2738 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] (Re-)joining group
2023-03-15 22:09:27.828  INFO 2738 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] Finished assignment for group at generation 4: {consumer-payment-topic-consumer-1-869a5012-379d-4d55-8302-ea59516b9534=Assignment(partitions=[payment-request-0]), consumer-payment-topic-consumer-3-d232888b-97ac-4bda-ba94-8813dd7fdd0a=Assignment(partitions=[])}
2023-03-15 22:09:27.835  INFO 2738 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] SyncGroup failed: The group began another rebalance. Need to re-join the group. Sent generation was Generation{generationId=4, memberId='consumer-payment-topic-consumer-1-869a5012-379d-4d55-8302-ea59516b9534', protocol='range'}
2023-03-15 22:09:27.835  INFO 2738 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] (Re-)joining group
2023-03-15 22:09:27.840  INFO 2738 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] Successfully joined group with generation Generation{generationId=5, memberId='consumer-payment-topic-consumer-3-d232888b-97ac-4bda-ba94-8813dd7fdd0a', protocol='range'}
2023-03-15 22:09:27.843  INFO 2738 --- [-consumer-1-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-2, groupId=payment-topic-consumer] Successfully joined group with generation Generation{generationId=5, memberId='consumer-payment-topic-consumer-2-416bbd0b-2cc0-4e03-bc7f-a73e53c6eb64', protocol='range'}
2023-03-15 22:09:27.843  INFO 2738 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] Successfully joined group with generation Generation{generationId=5, memberId='consumer-payment-topic-consumer-1-869a5012-379d-4d55-8302-ea59516b9534', protocol='range'}
2023-03-15 22:09:27.844  INFO 2738 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] Finished assignment for group at generation 5: {consumer-payment-topic-consumer-1-869a5012-379d-4d55-8302-ea59516b9534=Assignment(partitions=[payment-request-0]), consumer-payment-topic-consumer-2-416bbd0b-2cc0-4e03-bc7f-a73e53c6eb64=Assignment(partitions=[]), consumer-payment-topic-consumer-3-d232888b-97ac-4bda-ba94-8813dd7fdd0a=Assignment(partitions=[])}
2023-03-15 22:09:27.850  INFO 2738 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] Successfully synced group in generation Generation{generationId=5, memberId='consumer-payment-topic-consumer-3-d232888b-97ac-4bda-ba94-8813dd7fdd0a', protocol='range'}
2023-03-15 22:09:27.850  INFO 2738 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] Successfully synced group in generation Generation{generationId=5, memberId='consumer-payment-topic-consumer-1-869a5012-379d-4d55-8302-ea59516b9534', protocol='range'}
2023-03-15 22:09:27.850  INFO 2738 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] Notifying assignor about the new Assignment(partitions=[])
2023-03-15 22:09:27.851  INFO 2738 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] Adding newly assigned partitions:
2023-03-15 22:09:27.851  INFO 2738 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] Notifying assignor about the new Assignment(partitions=[payment-request-0])
2023-03-15 22:09:27.852  INFO 2738 --- [-consumer-2-C-1] o.s.k.l.KafkaMessageListenerContainer    : payment-topic-consumer: partitions assigned: []
2023-03-15 22:09:27.853  INFO 2738 --- [-consumer-1-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-2, groupId=payment-topic-consumer] Successfully synced group in generation Generation{generationId=5, memberId='consumer-payment-topic-consumer-2-416bbd0b-2cc0-4e03-bc7f-a73e53c6eb64', protocol='range'}
2023-03-15 22:09:27.854  INFO 2738 --- [-consumer-1-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-2, groupId=payment-topic-consumer] Notifying assignor about the new Assignment(partitions=[])
2023-03-15 22:09:27.854  INFO 2738 --- [-consumer-1-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-2, groupId=payment-topic-consumer] Adding newly assigned partitions:
2023-03-15 22:09:27.854  INFO 2738 --- [-consumer-1-C-1] o.s.k.l.KafkaMessageListenerContainer    : payment-topic-consumer: partitions assigned: []
2023-03-15 22:09:27.856  INFO 2738 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] Adding newly assigned partitions: payment-request-0
2023-03-15 22:09:27.864  INFO 2738 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] Found no committed offset for partition payment-request-0
2023-03-15 22:09:27.879  INFO 2738 --- [-consumer-0-C-1] o.a.k.c.c.internals.SubscriptionState    : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] Resetting offset for partition payment-request-0 to position FetchPosition{offset=0, offsetEpoch=Optional.empty, currentLeader=LeaderAndEpoch{leader=Optional[192.168.0.4:9092 (id: 0 rack: null)], epoch=0}}.
2023-03-15 22:09:27.880  INFO 2738 --- [-consumer-0-C-1] o.s.k.l.KafkaMessageListenerContainer    : payment-topic-consumer: partitions assigned: [payment-request-0]
2023-03-15 22:09:27.921  WARN 2738 --- [pool-1-thread-2] o.h.engine.jdbc.spi.SqlExceptionHelper   : SQL Error: 0, SQLState: 23505
2023-03-15 22:09:27.922 ERROR 2738 --- [pool-1-thread-2] o.h.engine.jdbc.spi.SqlExceptionHelper   : ERROR: duplicate key value violates unique constraint "payment_order_outbox_saga_id_payment_status_outbox_status"
  Detail: Key (type, saga_id, payment_status, outbox_status)=(OrderProcessingSaga, 242a0c61-b7dd-4e22-ab62-6da5d32977c0, COMPLETED, STARTED) already exists.
2023-03-15 22:09:27.926  INFO 2738 --- [pool-1-thread-2] o.h.e.j.b.internal.AbstractBatchImpl     : HHH000010: On release of batch it still contained JDBC statements
2023-03-15 22:09:27.933 ERROR 2738 --- [pool-1-thread-2] .p.s.d.PaymentRequestMessageListenerTest : DataAccessException occurred for thread 2 with sql state: 23505
Hibernate: select orderoutbo0_.id as id1_2_, orderoutbo0_.created_at as created_2_2_, orderoutbo0_.outbox_status as outbox_s3_2_, orderoutbo0_.payload as payload4_2_, orderoutbo0_.payment_status as payment_5_2_, orderoutbo0_.processed_at as processe6_2_, orderoutbo0_.saga_id as saga_id7_2_, orderoutbo0_.type as type8_2_, orderoutbo0_.version as version9_2_ from order_outbox orderoutbo0_ where orderoutbo0_.type=? and orderoutbo0_.saga_id=? and orderoutbo0_.payment_status=? and orderoutbo0_.outbox_status=?
