Hibernate: select orderoutbo0_.id as id1_2_, orderoutbo0_.created_at as created_2_2_, orderoutbo0_.outbox_status as outbox_s3_2_, orderoutbo0_.payload as payload4_2_, orderoutbo0_.payment_status as payment_5_2_, orderoutbo0_.processed_at as processe6_2_, orderoutbo0_.saga_id as saga_id7_2_, orderoutbo0_.type as type8_2_, orderoutbo0_.version as version9_2_ from order_outbox orderoutbo0_ where orderoutbo0_.type=? and orderoutbo0_.saga_id=? and orderoutbo0_.payment_status=? and orderoutbo0_.outbox_status=?
2023-03-15 22:05:19.038  INFO 2694 --- [           main] c.f.o.s.p.s.domain.PaymentRequestHelper  : Received payment complete event for order id: fc439df3-a9e0-49d7-b1d4-60bfea476f75
Hibernate: select creditentr0_.id as id1_0_, creditentr0_.customer_id as customer2_0_, creditentr0_.total_credit_amount as total_cr3_0_ from credit_entry creditentr0_ where creditentr0_.customer_id=?
Hibernate: select credithist0_.id as id1_1_, credithist0_.amount as amount2_1_, credithist0_.customer_id as customer3_1_, credithist0_.type as type4_1_ from credit_history credithist0_ where credithist0_.customer_id=?
2023-03-15 22:05:19.138  INFO 2694 --- [           main] c.f.o.s.p.s.d.PaymentDomainServiceImpl   : Payment is initiated for order id: fc439df3-a9e0-49d7-b1d4-60bfea476f75
Hibernate: select paymentent0_.id as id1_3_0_, paymentent0_.created_at as created_2_3_0_, paymentent0_.customer_id as customer3_3_0_, paymentent0_.order_id as order_id4_3_0_, paymentent0_.price as price5_3_0_, paymentent0_.status as status6_3_0_ from payments paymentent0_ where paymentent0_.id=?
Hibernate: select credithist0_.id as id1_1_0_, credithist0_.amount as amount2_1_0_, credithist0_.customer_id as customer3_1_0_, credithist0_.type as type4_1_0_ from credit_history credithist0_ where credithist0_.id=?
2023-03-15 22:05:19.323  INFO 2694 --- [-consumer-2-C-1] org.apache.kafka.clients.Metadata        : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] Cluster ID: VQ1bB0ThSvaTYhqMF_orDQ
2023-03-15 22:05:19.323  INFO 2694 --- [-consumer-1-C-1] org.apache.kafka.clients.Metadata        : [Consumer clientId=consumer-payment-topic-consumer-2, groupId=payment-topic-consumer] Cluster ID: VQ1bB0ThSvaTYhqMF_orDQ
2023-03-15 22:05:19.323  INFO 2694 --- [-consumer-0-C-1] org.apache.kafka.clients.Metadata        : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] Cluster ID: VQ1bB0ThSvaTYhqMF_orDQ
2023-03-15 22:05:19.326  INFO 2694 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] Discovered group coordinator 192.168.0.4:9092 (id: 2147483647 rack: null)
2023-03-15 22:05:19.326  INFO 2694 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] Discovered group coordinator 192.168.0.4:9092 (id: 2147483647 rack: null)
2023-03-15 22:05:19.326  INFO 2694 --- [-consumer-1-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-2, groupId=payment-topic-consumer] Discovered group coordinator 192.168.0.4:9092 (id: 2147483647 rack: null)
2023-03-15 22:05:19.331  INFO 2694 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] (Re-)joining group
2023-03-15 22:05:19.331  INFO 2694 --- [-consumer-1-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-2, groupId=payment-topic-consumer] (Re-)joining group
2023-03-15 22:05:19.332  INFO 2694 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] (Re-)joining group
2023-03-15 22:05:19.363  INFO 2694 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] Request joining group due to: need to re-join with the given member-id
2023-03-15 22:05:19.363  INFO 2694 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] (Re-)joining group
2023-03-15 22:05:19.364  INFO 2694 --- [-consumer-1-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-2, groupId=payment-topic-consumer] Request joining group due to: need to re-join with the given member-id
2023-03-15 22:05:19.366  INFO 2694 --- [-consumer-1-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-2, groupId=payment-topic-consumer] (Re-)joining group
2023-03-15 22:05:19.370  INFO 2694 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] Request joining group due to: need to re-join with the given member-id
2023-03-15 22:05:19.371  INFO 2694 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] (Re-)joining group
2023-03-15 22:05:19.372  INFO 2694 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] Successfully joined group with generation Generation{generationId=1, memberId='consumer-payment-topic-consumer-3-b6edce1c-f7bc-47b1-817d-3e1b7a6d5571', protocol='range'}
2023-03-15 22:05:19.377  INFO 2694 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] Finished assignment for group at generation 1: {consumer-payment-topic-consumer-3-b6edce1c-f7bc-47b1-817d-3e1b7a6d5571=Assignment(partitions=[payment-request-0])}
2023-03-15 22:05:19.388  INFO 2694 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] SyncGroup failed: The group began another rebalance. Need to re-join the group. Sent generation was Generation{generationId=1, memberId='consumer-payment-topic-consumer-3-b6edce1c-f7bc-47b1-817d-3e1b7a6d5571', protocol='range'}
2023-03-15 22:05:19.389  INFO 2694 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] (Re-)joining group
2023-03-15 22:05:19.392  INFO 2694 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] Successfully joined group with generation Generation{generationId=2, memberId='consumer-payment-topic-consumer-1-9081b232-bf11-4043-9b89-bda101f4b40a', protocol='range'}
2023-03-15 22:05:19.392  INFO 2694 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] Successfully joined group with generation Generation{generationId=2, memberId='consumer-payment-topic-consumer-3-b6edce1c-f7bc-47b1-817d-3e1b7a6d5571', protocol='range'}
2023-03-15 22:05:19.394  INFO 2694 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] Finished assignment for group at generation 2: {consumer-payment-topic-consumer-1-9081b232-bf11-4043-9b89-bda101f4b40a=Assignment(partitions=[payment-request-0]), consumer-payment-topic-consumer-3-b6edce1c-f7bc-47b1-817d-3e1b7a6d5571=Assignment(partitions=[]), consumer-payment-topic-consumer-2-d64b43fe-a519-4cc2-9a9c-cd32783434eb=Assignment(partitions=[])}
2023-03-15 22:05:19.394  INFO 2694 --- [-consumer-1-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-2, groupId=payment-topic-consumer] Successfully joined group with generation Generation{generationId=2, memberId='consumer-payment-topic-consumer-2-d64b43fe-a519-4cc2-9a9c-cd32783434eb', protocol='range'}
2023-03-15 22:05:19.403  INFO 2694 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] Successfully synced group in generation Generation{generationId=2, memberId='consumer-payment-topic-consumer-1-9081b232-bf11-4043-9b89-bda101f4b40a', protocol='range'}
2023-03-15 22:05:19.404  INFO 2694 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] Notifying assignor about the new Assignment(partitions=[payment-request-0])
2023-03-15 22:05:19.408  INFO 2694 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] Successfully synced group in generation Generation{generationId=2, memberId='consumer-payment-topic-consumer-3-b6edce1c-f7bc-47b1-817d-3e1b7a6d5571', protocol='range'}
2023-03-15 22:05:19.408  INFO 2694 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] Notifying assignor about the new Assignment(partitions=[])
2023-03-15 22:05:19.408  INFO 2694 --- [-consumer-2-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-3, groupId=payment-topic-consumer] Adding newly assigned partitions:
2023-03-15 22:05:19.411  INFO 2694 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] Adding newly assigned partitions: payment-request-0
2023-03-15 22:05:19.412  INFO 2694 --- [-consumer-2-C-1] o.s.k.l.KafkaMessageListenerContainer    : payment-topic-consumer: partitions assigned: []
2023-03-15 22:05:19.414  INFO 2694 --- [-consumer-1-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-2, groupId=payment-topic-consumer] Successfully synced group in generation Generation{generationId=2, memberId='consumer-payment-topic-consumer-2-d64b43fe-a519-4cc2-9a9c-cd32783434eb', protocol='range'}
2023-03-15 22:05:19.415  INFO 2694 --- [-consumer-1-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-2, groupId=payment-topic-consumer] Notifying assignor about the new Assignment(partitions=[])
2023-03-15 22:05:19.415  INFO 2694 --- [-consumer-1-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-2, groupId=payment-topic-consumer] Adding newly assigned partitions:
2023-03-15 22:05:19.415  INFO 2694 --- [-consumer-1-C-1] o.s.k.l.KafkaMessageListenerContainer    : payment-topic-consumer: partitions assigned: []
2023-03-15 22:05:19.425  INFO 2694 --- [-consumer-0-C-1] o.a.k.c.c.internals.ConsumerCoordinator  : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] Found no committed offset for partition payment-request-0
2023-03-15 22:05:19.461  INFO 2694 --- [-consumer-0-C-1] o.a.k.c.c.internals.SubscriptionState    : [Consumer clientId=consumer-payment-topic-consumer-1, groupId=payment-topic-consumer] Resetting offset for partition payment-request-0 to position FetchPosition{offset=0, offsetEpoch=Optional.empty, currentLeader=LeaderAndEpoch{leader=Optional[192.168.0.4:9092 (id: 0 rack: null)], epoch=0}}.
2023-03-15 22:05:19.465  INFO 2694 --- [-consumer-0-C-1] o.s.k.l.KafkaMessageListenerContainer    : payment-topic-consumer: partitions assigned: [payment-request-0]
Hibernate: select orderoutbo0_.id as id1_2_0_, orderoutbo0_.created_at as created_2_2_0_, orderoutbo0_.outbox_status as outbox_s3_2_0_, orderoutbo0_.payload as payload4_2_0_, orderoutbo0_.payment_status as payment_5_2_0_, orderoutbo0_.processed_at as processe6_2_0_, orderoutbo0_.saga_id as saga_id7_2_0_, orderoutbo0_.type as type8_2_0_, orderoutbo0_.version as version9_2_0_ from order_outbox orderoutbo0_ where orderoutbo0_.id=?
2023-03-15 22:05:19.582  INFO 2694 --- [           main] c.f.o.s.p.s.d.o.s.OrderOutboxHelper      : OrderOutboxMessage is saved with id: ae72bd88-410f-478f-bf7a-7fe77bea0a27
Hibernate: insert into payments (created_at, customer_id, order_id, price, status, id) values (?, ?, ?, ?, ?, ?)
Hibernate: insert into credit_history (amount, customer_id, type, id) values (?, ?, ?, ?)
Hibernate: insert into order_outbox (created_at, outbox_status, payload, payment_status, processed_at, saga_id, type, version, id) values (?, ?, ?, ?, ?, ?, ?, ?, ?)
Hibernate: update credit_entry set customer_id=?, total_credit_amount=? where id=?
Hibernate: select orderoutbo0_.id as id1_2_, orderoutbo0_.created_at as created_2_2_, orderoutbo0_.outbox_status as outbox_s3_2_, orderoutbo0_.payload as payload4_2_, orderoutbo0_.payment_status as payment_5_2_, orderoutbo0_.processed_at as processe6_2_, orderoutbo0_.saga_id as saga_id7_2_, orderoutbo0_.type as type8_2_, orderoutbo0_.version as version9_2_ from order_outbox orderoutbo0_ where orderoutbo0_.type=? and orderoutbo0_.saga_id=? and orderoutbo0_.payment_status=? and orderoutbo0_.outbox_status=?
2023-03-15 22:05:19.686  INFO 2694 --- [           main] c.f.o.s.p.s.domain.PaymentRequestHelper  : Received payment complete event for order id: 09969f59-4e86-48d0-b6ba-cd231906380a
Hibernate: select creditentr0_.id as id1_0_, creditentr0_.customer_id as customer2_0_, creditentr0_.total_credit_amount as total_cr3_0_ from credit_entry creditentr0_ where creditentr0_.customer_id=?
Hibernate: select credithist0_.id as id1_1_, credithist0_.amount as amount2_1_, credithist0_.customer_id as customer3_1_, credithist0_.type as type4_1_ from credit_history credithist0_ where credithist0_.customer_id=?
2023-03-15 22:05:19.696  INFO 2694 --- [           main] c.f.o.s.p.s.d.PaymentDomainServiceImpl   : Payment is initiated for order id: 09969f59-4e86-48d0-b6ba-cd231906380a
Hibernate: select paymentent0_.id as id1_3_0_, paymentent0_.created_at as created_2_3_0_, paymentent0_.customer_id as customer3_3_0_, paymentent0_.order_id as order_id4_3_0_, paymentent0_.price as price5_3_0_, paymentent0_.status as status6_3_0_ from payments paymentent0_ where paymentent0_.id=?
Hibernate: select credithist0_.id as id1_1_0_, credithist0_.amount as amount2_1_0_, credithist0_.customer_id as customer3_1_0_, credithist0_.type as type4_1_0_ from credit_history credithist0_ where credithist0_.id=?
Hibernate: select orderoutbo0_.id as id1_2_0_, orderoutbo0_.created_at as created_2_2_0_, orderoutbo0_.outbox_status as outbox_s3_2_0_, orderoutbo0_.payload as payload4_2_0_, orderoutbo0_.payment_status as payment_5_2_0_, orderoutbo0_.processed_at as processe6_2_0_, orderoutbo0_.saga_id as saga_id7_2_0_, orderoutbo0_.type as type8_2_0_, orderoutbo0_.version as version9_2_0_ from order_outbox orderoutbo0_ where orderoutbo0_.id=?
2023-03-15 22:05:19.725  INFO 2694 --- [           main] c.f.o.s.p.s.d.o.s.OrderOutboxHelper      : OrderOutboxMessage is saved with id: c9b81fd9-d1a9-464e-842a-438cb9506b4a
Hibernate: insert into payments (created_at, customer_id, order_id, price, status, id) values (?, ?, ?, ?, ?, ?)
Hibernate: insert into credit_history (amount, customer_id, type, id) values (?, ?, ?, ?)
Hibernate: insert into order_outbox (created_at, outbox_status, payload, payment_status, processed_at, saga_id, type, version, id) values (?, ?, ?, ?, ?, ?, ?, ?, ?)
2023-03-15 22:05:19.750  WARN 2694 --- [           main] o.h.engine.jdbc.spi.SqlExceptionHelper   : SQL Error: 0, SQLState: 23505
2023-03-15 22:05:19.750 ERROR 2694 --- [           main] o.h.engine.jdbc.spi.SqlExceptionHelper   : ERROR: duplicate key value violates unique constraint "payment_order_outbox_saga_id_payment_status_outbox_status"
  Detail: Key (type, saga_id, payment_status, outbox_status)=(OrderProcessingSaga, f20ca4e0-439c-4020-a122-feecaca5d124, COMPLETED, STARTED) already exists.
2023-03-15 22:05:19.756  INFO 2694 --- [           main] o.h.e.j.b.internal.AbstractBatchImpl     : HHH000010: On release of batch it still contained JDBC statements
2023-03-15 22:05:19.762 ERROR 2694 --- [           main] .p.s.d.PaymentRequestMessageListenerTest : DataAccessException occurred with sql state: 23505
Hibernate: select orderoutbo0_.id as id1_2_, orderoutbo0_.created_at as created_2_2_, orderoutbo0_.outbox_status as outbox_s3_2_, orderoutbo0_.payload as payload4_2_, orderoutbo0_.payment_status as payment_5_2_, orderoutbo0_.processed_at as processe6_2_, orderoutbo0_.saga_id as saga_id7_2_, orderoutbo0_.type as type8_2_, orderoutbo0_.version as version9_2_ from order_outbox orderoutbo0_ where orderoutbo0_.type=? and orderoutbo0_.saga_id=? and orderoutbo0_.payment_status=? and orderoutbo0_.outbox_status=?
